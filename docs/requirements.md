# カテゴリマッピングWebアプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1 目的
国内主要ECモール（メルカリShops、楽天市場、ヤフーショッピング）間のカテゴリコードをLLMを使用して自動マッピングするWebアプリケーション。

### 1.2 対象モール
- メルカリShops
- 楽天市場
- ヤフーショッピング

## 2. 機能要件

### 2.1 商品名からのマッピング機能

#### 2.1.1 基本機能
- ホーム画面で商品名を入力（改行区切り、最大100行）
- 各行の商品名に対して、各モールのカテゴリIDとフルパスを自動割り当て
- 結果をテーブル形式で表示（読み取り専用）
- プロダクト説明と使い方ガイドをホーム画面に表示

#### 2.1.2 UI要件
- **画面レイアウト**: 画面横幅いっぱいに表示領域を確保
- **商品名列**: 
  - 幅350px（他の列より長く）
  - 2行表示で折り返し（`line-clamp-2`）
  - テキストサイズ: `text-xs`
- **結果表示**: 
  - 編集不可（読み取り専用）
  - カテゴリIDを先頭に太字（`font-bold`）で表示
  - フルパスをmuted色（`text-muted-foreground`）で2行表示
- **テーブル全体**:
  - 固定幅レイアウト（`table-fixed`）
  - 1画面に収まる高さ制限（`max-h-[calc(100vh-300px)]`）
  - テキストサイズ: `text-xs`

#### 2.1.3 エクスポート機能
- クリップボードコピー: カテゴリIDとフルパスを含む
- CSVダウンロード: カテゴリIDとフルパスを含む

### 2.2 AIマッピング仕様

#### 2.2.1 使用モデル
- **商品名からのマッピング**: `gemini-2.0-flash-lite`（軽量モデル、速度重視）

#### 2.2.2 RAG（Retrieval-Augmented Generation）実装
- 商品名からキーワードを抽出
- 関連カテゴリを検索（最大50件）
- 関連カテゴリが20件未満の場合は、全カテゴリから30件を追加
- モールごとに並列処理でマッピングを実行

#### 2.2.3 プロンプト要件
- カテゴリリストをコンテキストに含める
- 「全てのカテゴリから選択してください」という指示を含める
- 「カテゴリIDは必ず上記のリストに含まれているものを使用してください」という指示を含める
- JSON形式でレスポンスを返す


## 3. 技術スタック

### 3.1 フロントエンド
- **フレームワーク**: Next.js 16 (App Router)
- **言語**: TypeScript
- **UIライブラリ**: React 19
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: shadcn/ui

### 3.2 バックエンド
- **API**: Next.js Server Actions（外部公開不要なAPI）
- **APIルート**: Hono（将来の拡張用）

### 3.3 データベース
- **データベース**: Turso (LibSQL)
- **ORM**: Drizzle ORM
- **ローカル開発**: SQLite

### 3.4 AI/LLM
- **SDK**: Vercel AI SDK
- **モデル**: Google Gemini API
  - `gemini-2.0-flash-lite`（商品名からのマッピング）

### 3.5 その他のライブラリ
- **バリデーション**: Zod
- **フォーム管理**: React Hook Form
- **クライアントfetch**: useSWR
- **クエリ状態管理**: nuqs
- **日付制御**: date-fns
- **CSV処理**: csv-parse
- **文字エンコーディング**: iconv-lite（Shift_JIS対応）

### 3.6 ホスティング
- **本番環境**: Vercel

## 4. データベース設計

### 4.1 categoriesテーブル
カテゴリマスタデータ

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | text (PK) | カテゴリID（nanoid） |
| mall_name | text | モール名（mercari_shops, rakuten, yahoo_shopping） |
| category_name | text | カテゴリ名 |
| category_id | text | カテゴリID（モール固有） |
| full_path | text | カテゴリのフルパス（例: "家具・インテリア > ケース・ボックス・コンテナ"） |
| parent_category_id | text | 親カテゴリID（階層構造がある場合） |
| created_at | integer | 作成日時 |
| updated_at | integer | 更新日時 |

### 4.2 mapping_learningsテーブル
マッピング学習データ

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | text (PK) | 学習データID（nanoid） |
| source_mall | text | 元モール名 |
| source_category_name | text | 元カテゴリ名 |
| source_category_id | text | 元カテゴリID |
| target_mall | text | ターゲットモール名 |
| target_category_name | text | ターゲットカテゴリ名 |
| target_category_id | text | ターゲットカテゴリID |
| is_manual_correction | integer (boolean) | 手動修正フラグ |
| created_at | integer | 作成日時 |

## 5. UI/UX要件

### 5.1 ホーム画面（商品名からのマッピング）

#### 5.1.1 プロダクト説明セクション
- **タイトル**: 「カテゴリマッピングツール」
- **概要**: LLMを使用した自動マッピングの説明
- **機能説明**: 主な機能を箇条書きで表示
- **対応モール**: メルカリShops、楽天市場、ヤフーショッピング
- **使い方**: 4ステップの手順を番号付きリストで表示

#### 5.1.2 入力フォーム
- **プレースホルダー**: 改行区切りで表示
  ```
  商品名1
  商品名2
  商品名3
  ```
- **バリデーション**: 必須入力、最大100行

#### 5.1.3 結果テーブル
- **列構成**:
  - 商品名列（350px）: 2行表示、折り返し
  - メルカリShops列（250px）: カテゴリID（太字）+ フルパス（muted色、2行）
  - 楽天市場列（250px）: カテゴリID（太字）+ フルパス（muted色、2行）
  - ヤフーショッピング列（250px）: カテゴリID（太字）+ フルパス（muted色、2行）
- **テキストサイズ**: `text-xs`
- **編集**: 不可（読み取り専用）

## 6. 実装済み機能

### 6.1 完了済み
- ✅ データベーススキーマ定義
- ✅ CSVファイルからのカテゴリデータ投入（Shift_JIS対応）
- ✅ 商品名からのマッピング機能（ホーム画面に統合）
- ✅ プロダクト説明と使い方ガイドの表示
- ✅ RAGによる関連カテゴリ検索
- ✅ モールごとの並列マッピング処理
- ✅ マッピング結果テーブル（読み取り専用）
- ✅ クリップボードコピー機能
- ✅ CSVダウンロード機能

### 6.2 未実装（MVP外）
- ❌ ユーザー認証
- ❌ 保存機能（マッピング結果の保存）
- ❌ 学習データの活用（次回マッピング時の精度向上）

## 7. パフォーマンス要件

### 7.1 処理速度
- 商品名からのマッピング: 軽量モデルを使用して高速化
- モールごとの並列処理で速度向上

### 7.2 精度
- RAGによる関連カテゴリ検索で精度向上
- コンテキストサイズを小さくして精度と速度を両立

## 8. 制限事項

### 8.1 MVP制限
- 商品名からのマッピング: 最大100行まで
- ユーザー認証なし
- 保存機能なし

## 9. 開発環境セットアップ

### 9.1 必要な環境変数
```env
GEMINI_API_KEY=your_gemini_api_key
TURSO_DATABASE_URL=file:./db/local/local.db
TURSO_AUTH_TOKEN=local
```

### 9.2 初期データ投入
```bash
TURSO_DATABASE_URL="file:./db/local/local.db" TURSO_AUTH_TOKEN="local" pnpm tsx scripts/seed-categories.ts
```

## 10. 今後の拡張予定

### 10.1 機能拡張
- 学習データを活用したマッピング精度向上
- マッピング結果の保存機能
- ユーザー認証機能
- マッピング履歴の表示

### 10.2 パフォーマンス改善
- キャッシュ機能の追加
- バッチ処理の最適化

## 11. 参照情報

### 11.1 主要ファイル
- `app/page.tsx`: ホーム画面（商品名からのマッピング機能）
- `app/actions/ai-mapping.ts`: AIマッピング処理
- `app/actions/categories.ts`: カテゴリ検索・取得
- `components/mapping-result-table.tsx`: マッピング結果テーブル
- `components/export-buttons.tsx`: エクスポート機能
- `db/schema.ts`: データベーススキーマ
- `lib/types.ts`: 型定義

### 11.2 重要な設計判断
- **Server Actions使用**: 外部公開不要なAPIはServer Actionsで実装
- **RAG実装**: コンテキストサイズを小さくし、関連カテゴリのみをLLMに渡す
- **並列処理**: モールごとに並列でマッピング処理を実行
- **軽量モデル**: 商品名からのマッピングは速度重視で軽量モデルを使用

---

**最終更新日**: 2024年12月
**バージョン**: 1.1.0

